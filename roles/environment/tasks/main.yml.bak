---
- name: modify /etc/hosts
  shell: >
         cat /etc/hosts | grep controller && sed -i '/controller/s/.*/{{controller_ip}} controller/' /etc/hosts || echo "{{controller_ip}} controller" >> /etc/hosts ;
         cat /etc/hosts | grep network && sed -i '/network/s/.*/{{network_ip}} network/' /etc/hosts || echo "{{network_ip}} network" >> /etc/hosts ;
         cat /etc/hosts | grep compute && sed -i '/compute/s/.*/{{compute_ip}} compute/' /etc/hosts || echo "{{compute_ip}} compute" >> /etc/hosts ;
- name: Update the repository cache
  apt: update_cache=yes
- name: install chrony
  apt: name=chrony state=present
- name: modify /etc/chrony/chrony.conf
  template: src=chrony.conf dest=/etc/chrony/chrony.conf
  notify:
    - restart chrony
  tags:
    - chrony
- name: install software-properties-common
  apt: name=software-properties-common state=present
- name: add "cloud-archive:newton" repository
  apt_repository: repo='deb http://ubuntu-cloud.archive.canonical.com/ubuntu xenial-updates/newton main' state=present filename='cloudarchive-newton'
- name: upgrade all packages
  apt: upgrade=dist force=yes
#- name: reboot
#  command: reboot
- name: set var node_type
  set_fact:
    node_type: "{{group_names | to_json }}"
- name: install mariadb-server
  apt: name=mariadb-server state=present
  when: node_type.find('controller') != -1
- name: install python-pymysql
  apt: name=python-pymysql state=present
  when: node_type.find('controller') != -1
- name: modify /etc/mysql/mariadb.conf.d/99-openstack.cnf
  template: src=99-openstack.cnf dest=/etc/mysql/mariadb.conf.d/99-openstack.cnf
  when: node_type.find('controller') != -1
  notify: 
    - restart mariadb
- name: install rabbitmq-server
  apt: name=rabbitmq-server state=present
  when: node_type.find('controller') != -1
- name: add rabbitmq user and config privileges
  rabbitmq_user: user={{rabbit_user}} password={{rabbit_passwd}} permissions=[{vhost='/', configure_priv='.*', read_priv='.*', write_priv='.*'}] state=present
- name: install memcached
  apt: name=memcached state=present
  when: node_type.find('controller') != -1
- name: install python-memcache
  apt: name=python-memcache state=present
  when: node_type.find('controller') != -1
- name: modify /etc/memcached.conf
  template: src=memcached.conf dest=/etc/memcached.conf
  when: node_type.find('controller') != -1
  notify: restart memcached
  tags:
    - modify_memcached
- name: install apache2
  apt: name=apache2 state=present
  when: node_type.find('controller') != -1
